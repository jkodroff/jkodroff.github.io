<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Josh Kodroff, Code Craftsman]]></title>
  <link href="http://joshkodroff.com/atom.xml" rel="self"/>
  <link href="http://joshkodroff.com/"/>
  <updated>2015-08-29T09:09:41-04:00</updated>
  <id>http://joshkodroff.com/</id>
  <author>
    <name><![CDATA[Josh Kodroff]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[An Elegant Abandoned Cart Email Using NServiceBus]]></title>
    <link href="http://joshkodroff.com/blog/2015/08/21/an-elegant-abandoned-cart-email-using-nservicebus/"/>
    <updated>2015-08-21T20:30:59-04:00</updated>
    <id>http://joshkodroff.com/blog/2015/08/21/an-elegant-abandoned-cart-email-using-nservicebus</id>
    <content type="html"><![CDATA[<h2>Abstract</h2>

<p>Some of the toughest requirements to model in enterprise development are business rules that involve the dimension of time.  In this post I&rsquo;ll show you how to fulfill those types of requirements in an elegant, testable, and scalable way using a message-driven style with <a href="http://particular.net/nservicebus">NServiceBus</a>.</p>

<h2>tl;dr</h2>

<p>If you&rsquo;re familiar NServiceBus and specifically its <a href="docs.particular.net/nservicebus/sagas/">sagas feature</a>, you can check out <a href="https://github.com/jkodroff/nsb-abandoned-cart">the code on GitHub</a>.  Of particular interest would be <a href="https://github.com/jkodroff/nsb-abandoned-cart/blob/master/src/Server/Saga.cs">the saga</a> and <a href="https://github.com/jkodroff/nsb-abandoned-cart/blob/master/src/Server.Tests/SagaTests.cs">its tests</a>.  There&rsquo;s also a <a href="https://github.com/jkodroff/nsb-abandoned-cart/blob/master/src/Client/Program.cs">console app client</a> that will let you play around.</p>

<!-- more -->


<h2>A Common Requirement and a Common Implementation</h2>

<p>A common requirement in eCommerce systems might go like this:</p>

<blockquote><p>If a customer adds an item to their cart and does not complete the checkout process within <code>$SOME_AMOUNT_OF_TIME</code>, send them an email reminding them that they have items in their cart.</p></blockquote>

<p>Many systems will solve this problem using a batch job.  It&rsquo;ll go something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="kt">var</span> <span class="n">abandonedCartThreshold</span> <span class="p">=</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromDays</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">foreach</span> <span class="p">(</span><span class="n">cart</span> <span class="k">in</span> <span class="n">allCarts</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// a cart disappears when it becomes an order</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">cart</span><span class="p">.</span><span class="n">Items</span><span class="p">.</span><span class="n">Any</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span> <span class="p">-</span> <span class="n">x</span><span class="p">.</span><span class="n">CreatedOn</span> <span class="p">&lt;=</span> <span class="n">abandonedCartThreshold</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// fetch customer to whom the cart belongs</span>
</span><span class='line'>        <span class="c1">// send email</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This might be fine for a simple system with low numbers of customers, but for most real-world systems there&rsquo;s several drawbacks with this approach that we need to consider:</p>

<ol>
<li><strong>It&rsquo;s slow, especially if you&rsquo;re sending the email synchronously:</strong> Network operations like sending email are the slowest types of operations.  And if our business is doing well, has tons of customers, and the nightly job&rsquo;s time exceeds 24 hours, we&rsquo;re in big trouble because it will never complete.  A single process cannot handle the load, so we&rsquo;re going to have to get into multiple processes with batching.  That&rsquo;s going to get ugly.</li>
<li><strong>We have to keep track of what&rsquo;s already been sent:</strong> Customers <em>really</em> don&rsquo;t like getting duplicate emails. If we have an error in the middle of the loop, we will have to keep track of which emails have already been sent in order to avoid annoyed customers.</li>
<li><strong>It doesn&rsquo;t deal with network partitions:</strong> We have to handle retrying the job in the event that something is seriously wrong, e.g. the mail server is unavailable.  In many systems this will involve an administrator or developer manually running the process again.  That&rsquo;s not the phone call you want to receive that wakes you up.</li>
<li><strong>It&rsquo;s not as precise as it could be:</strong> We&rsquo;re sending the email every night.  While an abandoned cart email probably isn&rsquo;t critical to be sent <em>exactly</em> <code>$SOME_AMOUNT_OF_TIME</code> after the last item is added to the cart, there are other communications that may be, e.g. if payment could not be captured on a large order, so learning to be precise here has applications in other areas.</li>
<li><strong>The code doesn&rsquo;t adapt well for new requirements:</strong> If we want to, e.g send several follow-up emails after 7 and 30 days, we&rsquo;re going to need to add yet some more fields to the DB for every customer and keep track of that state as well.</li>
<li><strong>It doesn&rsquo;t deal well with problems like invalid data:</strong> If we make a mistake in our error handling or our logic (e.g. if we run into an unexpected bug with 1 specific customer without a valid email address, <em>who was undoubtedly imported directly into the database, skipping our painstakingly crafted validation in our application code</em> (because that&rsquo;s what happens out there in the real world), our process will die.  Ok, so we can add try/catch block.  And we need to add tests for that.  And if you are inclinded towards software craftsmanship, it should strike you as wrong that we&rsquo;re going to retry the same broken customer every time we run the job, so now we need to add even more state via a flag to make sure we don&rsquo;t send the email to a customer who has failed <code>$SOME_NUMBER_OF_TIMES</code>.  That&rsquo;s a lot of additional logic we need to account for.</li>
<li><strong>It&rsquo;s difficult to test:</strong>  How can we tell how this thing going to perform in production?  How can we be confident that it works correctly?  The state that the job encompasses includes all carts in the system, so it&rsquo;s difficult to say short of creating 10,000 carts and customers, then sending 10,000 emails.  That can run into issues like getting your employer blacklisted for bad email behavior.   Of course, we can use things like <a href="https://en.wikipedia.org/wiki/Dependency_injection">dependency injection</a> for testing, but because we&rsquo;re not sending a real email, we won&rsquo;t get anything like production performance.</li>
</ol>


<p>Those are pretty significant issues, so what are we going to do?</p>

<h2>Enter The Saga</h2>

<p>Luckily, there&rsquo;s a better way to do this: The saga pattern is the right tool for this job. It&rsquo;s tricky to describe a saga conscisely, so here&rsquo;s a list of things <em>about sagas</em> that might help you conceptualize them:</p>

<ol>
<li><strong>They&rsquo;re state machines:</strong> You can think of them like a flow chart that represents a slow-running business process.  Where &ldquo;slow-running&rdquo; is defined as &ldquo;at least computer time slow, and maybe even human-time slow&rdquo;, e.g. an ordering process that requires multiple calls to HTTP-based APIs or&hellip; an abandoned cart email that needs to be sent 1 day after the last item is added to the cart (fancy that!).</li>
<li><strong>They&rsquo;re coordinators:</strong> They wait for things to happen (e.g. for the warehouse to tell us that an order has shipped), and then they tell the system to do things (e.g. charge the customers card, send the customer a email telling them their order has shipped).</li>
<li><strong>They&rsquo;re persistent entities:</strong> Because the processes they model are slow-running, they have to persist the state of the process after each step is done.  We can&rsquo;t expect to keep this process running in memory for 3 days while a placed order is packaged at a warehouse.  Because they&rsquo;re loaded by a unique identifier they are <a href="http://martinfowler.com/bliki/EvansClassification.html">entities</a> domain-driven design terms.  (They&rsquo;re also <a href="http://stackoverflow.com/questions/1958621/whats-an-aggregate-root">aggregate roots</a>, although I think this distinction can be confusing so feel free to ignore it.)</li>
</ol>


<p>We also get the following benefits with NServiceBus' implementation of sagas:</p>

<ol>
<li><strong>Retrying failed messages:</strong> Sagas in NServiceBus are also message handlers and NServiceBus message handlers <a href="http://docs.particular.net/nservicebus/errors/automatic-retries">automatically retry failed messages</a>.  This feature is very very useful when dealing with, e.g <a href="https://twitter.com/search?q=mailgun%20%5Bstatus%5D&amp;src=typd">a temporary outage on our mail service</a>.</li>
<li><strong>Persisting state between messages:</strong> The NServiceBus <code>Saga</code> class (from which we inherit) is already designed to handle persisting the state after each message in the saga is handled.  More code we don&rsquo;t have to write.</li>
<li><strong>The dimension of time can easily be modeled and tested:</strong> NServiceBus sagas allow us to express a process over time through its <a href="http://docs.particular.net/nservicebus/sagas/timeouts">timeouts feature</a>.  This feature is going to be key to implementing our requirement as you&rsquo;ll see very soon.</li>
<li><strong>Our saga will run asynchronously:</strong> NServiceBus message handlers (which include sagas) run asynchronously, which will allow us to <a href="http://docs.particular.net/samples/scaleout/">scale out</a> by running multiple copies of our saga endpoint if we need to.</li>
</ol>


<h2>Creating our NServiceBus Saga: First Steps</h2>

<p><strong>Note:</strong> This section assumes you have a basic understanding of NServiceBus' message types.  If you don&rsquo;t you should <a href="http://docs.particular.net/nservicebus/messaging/messages-events-commands">read this</a>.</p>

<p>The first thing we need to do is to create some messages which will be sent by our client application via NServiceBus' <code>Bus.Send()</code> method.  This is probably an ASP.NET MVC application, but they could just as easily be sent from a console application, or anywhere really.  If we&rsquo;re following the typical messaging semantics these should be events, but because there&rsquo;s a high likelihood they are sent from a website, we should not use <code>Bus.Publish()</code> (<a href="http://www.make-awesome.com/2010/10/why-not-publish-nservicebus-messages-from-a-web-application/">detailed explanation here</a>).</p>

<p>Here&rsquo;s our messages:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="c1">// When we get one of these, we will reset the countdown to sending the email:</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ItemAddedToCart</span> <span class="p">:</span> <span class="n">IMessage</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">UserName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// When we get one of these, we will cancel the entire </span>
</span><span class='line'><span class="c1">// process because the the cart is no longer abandoned:</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">OrderSubmitted</span> <span class="p">:</span> <span class="n">IMessage</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">UserName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we&rsquo;re ready to create our saga.  When we create a saga in NServiceBus, we need to define 2 things:</p>

<ol>
<li>The class which will hold the saga&rsquo;s state in between messages.  This is where we&rsquo;ll keep track of which messages were received and any state that we need to keep track of between messages.</li>
<li>The message that begins the saga.</li>
</ol>


<p>Let&rsquo;s do that now:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">AbandonedCartSagaData</span> <span class="p">:</span> <span class="n">IContainSagaData</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// Built-in saga properties:</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">Guid</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">Originator</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">OriginalMessageId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">AbandonedCartSaga</span> <span class="p">:</span>
</span><span class='line'>  <span class="n">Saga</span><span class="p">&lt;</span><span class="n">AbandonedCartSagaData</span><span class="p">&gt;,</span>
</span><span class='line'>  <span class="n">IAmStartedByMessages</span><span class="p">&lt;</span><span class="n">ItemAddedToCart</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">ItemAddedToCart</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We need to tell NServiceBus how to get from an incoming message to the right saga (one saga per customer, keyed off the username).</p>

<p>Add this to <code>AbandonedCartSagaData</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="c1">// This needs to be unique so that we can scale out, or </span>
</span><span class='line'><span class="c1">// we might get 2 Sagas with the same username, </span>
</span><span class='line'><span class="c1">// per https://twitter.com/UdiDahan/status/587896128688951297</span>
</span><span class='line'><span class="na">[Unique]</span>
</span><span class='line'><span class="k">public</span> <span class="kt">string</span> <span class="n">UserName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And add this to <code>AbandonedCartSaga</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">ConfigureHowToFindSaga</span><span class="p">(</span><span class="n">SagaPropertyMapper</span><span class="p">&lt;</span><span class="n">AbandonedCartSagaData</span><span class="p">&gt;</span> <span class="n">mapper</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">mapper</span>
</span><span class='line'>        <span class="p">.</span><span class="n">ConfigureMapping</span><span class="p">&lt;</span><span class="n">ItemAddedToCart</span><span class="p">&gt;(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">UserName</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">ToSaga</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">UserName</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">mapper</span>
</span><span class='line'>        <span class="p">.</span><span class="n">ConfigureMapping</span><span class="p">&lt;</span><span class="n">OrderSubmitted</span><span class="p">&gt;(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">UserName</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">ToSaga</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">UserName</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Creating our NServiceBus Saga: Business Logic</h2>

<p>First we need to understand <a href="http://docs.particular.net/nservicebus/sagas/timeouts">timeouts in NServiceBus sagas</a>.  A timeout message is like a programmable boomerang: the saga sends the timeout message (which can contain whatever additional data you want), and it&rsquo;ll &ldquo;come back&rdquo; to the saga in whatever <code>TimeSpan</code> you specify when you call <code>RequestTimeout()</code> from within the saga.</p>

<p>We&rsquo;re going to model our business process in our saga like this:</p>

<ol>
<li>Every time we receive <code>ItemAddedToCart</code>, we&rsquo;ll send a timeout message <code>AbandonedCartTimeOut</code> with a newly generated unique identifier.  We&rsquo;ll also store this ID in the saga&rsquo;s data.</li>
<li>When we receive <code>AbandonedCartTimeOut</code>, if the ID of the incoming message does not match ID of the last sent message in the saga, we&rsquo;ll know that an item has been added to the cart since the timeout message was issued.  If the IDs match, we&rsquo;ll send the email and complete the saga.</li>
<li>If we receive an <code>OrderSubmitted</code> message, we don&rsquo;t need to send the email because the customer has completed the checkout process and we&rsquo;ll complete the saga.</li>
</ol>


<p>Let&rsquo;s do that now.  First, we&rsquo;ll need to create our timeout message.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">AbandonedCartTimeOut</span> <span class="p">:</span> <span class="n">IMessage</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="n">Guid</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add this to <code>AbandonedCartEmailSagaData</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="n">Guid</span> <span class="n">LastTimeOutId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add this to <code>AbandonedCartEmailSaga</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">ItemAddedToCart</span> <span class="n">message</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Data</span><span class="p">.</span><span class="n">UserName</span> <span class="p">=</span> <span class="n">message</span><span class="p">.</span><span class="n">UserName</span><span class="p">;</span>
</span><span class='line'>    <span class="n">Data</span><span class="p">.</span><span class="n">LastTimeOutId</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="n">RequestTimeout</span><span class="p">(</span>
</span><span class='line'>        <span class="c1">// We&#39;re using 5 seconds because it makes it easy to test,</span>
</span><span class='line'>        <span class="c1">// but in a real system, we might want to provide this via</span>
</span><span class='line'>        <span class="c1">// a configurable variable.</span>
</span><span class='line'>        <span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="m">5</span><span class="p">),</span>
</span><span class='line'>        <span class="k">new</span> <span class="n">AbandonedCartTimeout</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Id</span> <span class="p">=</span> <span class="n">Data</span><span class="p">.</span><span class="n">LastTimeOutId</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">OrderSubmitted</span> <span class="n">message</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">MarkAsComplete</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">Timeout</span><span class="p">(</span><span class="n">AbandonedCartTimeout</span> <span class="n">state</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">Data</span><span class="p">.</span><span class="n">LastTimeOutId</span> <span class="p">!=</span> <span class="n">state</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// This is not the last timeout issued, so ignore it.</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Bus</span><span class="p">.</span><span class="n">SendLocal</span><span class="p">(</span><span class="k">new</span> <span class="n">SendAbandonedCartEmail</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">UserName</span> <span class="p">=</span> <span class="n">Data</span><span class="p">.</span><span class="n">UserName</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">MarkAsComplete</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>How to Test Our NServiceBus Saga</h2>

<p>There&rsquo;s 2 philosophies when it comes to testing NServiceBus sagas:</p>

<ol>
<li><strong>Unit Testing:</strong> We test each message handler in the saga in isolation, setting up the saga&rsquo;s internal state (i.e. <code>AbandonedCartSagaData</code> in our case) for each message, possibly with several tests for each message handler (if the handler can exhibit several different behaviors).</li>
<li><strong>End-to-End Testing:</strong> We test the entire flow of a saga from start to completion.</li>
</ol>


<p>I think the latter approach provides some significant advantages:</p>

<ol>
<li><strong>It more closely resembles real-world usage:</strong> Our saga exists in the wild as a thing that handles a distinct series of messages, with its state managed internally, so it&rsquo;s better to test it that way.</li>
<li><strong>It requires less code:</strong> NServiceBus' testing facilities provide a convenient way to do this type of testing via <a href="https://en.wikipedia.org/wiki/Method_chaining">method chaining</a>.</li>
</ol>


<h2>Actually Testing Our NServiceBus Saga</h2>

<p>We have 2 distinct scenarios.  First, let&rsquo;s do the &ldquo;happy path&rdquo; (from the view of an eCommerce retailer) where the order gets placed.  (The assertion methods pictured below are done with <a href="http://www.fluentassertions.com/">FluentAssertions</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="na">[Test]</span>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">OrderSubmitted</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">userName</span> <span class="p">=</span> <span class="s">&quot;sales@joshkodroff.com&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">timeoutId1</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Test</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Saga</span><span class="p">&lt;</span><span class="n">AbandonedCartSaga</span><span class="p">&gt;()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">ExpectTimeoutToBeSetIn</span><span class="p">&lt;</span><span class="n">AbandonedCartTimeout</span><span class="p">&gt;((</span><span class="n">msg</span><span class="p">,</span> <span class="n">span</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">timeoutId1</span> <span class="p">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">Id</span><span class="p">;</span>
</span><span class='line'>            <span class="n">span</span><span class="p">.</span><span class="n">Should</span><span class="p">().</span><span class="n">Be</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="m">5</span><span class="p">));</span>
</span><span class='line'>        <span class="p">})</span>
</span><span class='line'>        <span class="p">.</span><span class="n">When</span><span class="p">(</span><span class="n">saga</span> <span class="p">=&gt;</span> <span class="n">saga</span><span class="p">.</span><span class="n">Handle</span><span class="p">(</span><span class="k">new</span> <span class="n">ItemAddedToCart</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">UserName</span> <span class="p">=</span> <span class="n">userName</span>
</span><span class='line'>        <span class="p">}))</span>
</span><span class='line'>        <span class="p">.</span><span class="n">ExpectTimeoutToBeSetIn</span><span class="p">&lt;</span><span class="n">AbandonedCartTimeout</span><span class="p">&gt;((</span><span class="n">msg</span><span class="p">,</span> <span class="n">span</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// just to make sure we&#39;re generating new ids</span>
</span><span class='line'>            <span class="n">msg</span><span class="p">.</span><span class="n">Id</span><span class="p">.</span><span class="n">Should</span><span class="p">().</span><span class="n">NotBe</span><span class="p">(</span><span class="n">timeoutId1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">span</span><span class="p">.</span><span class="n">Should</span><span class="p">().</span><span class="n">Be</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="m">5</span><span class="p">));</span>
</span><span class='line'>        <span class="p">})</span>
</span><span class='line'>        <span class="p">.</span><span class="n">When</span><span class="p">(</span><span class="n">saga</span> <span class="p">=&gt;</span> <span class="n">saga</span><span class="p">.</span><span class="n">Handle</span><span class="p">(</span><span class="k">new</span> <span class="n">ItemAddedToCart</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">UserName</span> <span class="p">=</span> <span class="n">userName</span>
</span><span class='line'>        <span class="p">}))</span>
</span><span class='line'>        <span class="c1">// just a dummy check.  no message should be sent</span>
</span><span class='line'>        <span class="p">.</span><span class="n">ExpectNotSend</span><span class="p">&lt;</span><span class="n">SendAbandonedCartEmail</span><span class="p">&gt;(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">When</span><span class="p">(</span><span class="n">saga</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// the first timeout comes back (which should be ignored):</span>
</span><span class='line'>            <span class="n">saga</span><span class="p">.</span><span class="n">Timeout</span><span class="p">(</span><span class="k">new</span> <span class="n">AbandonedCartTimeout</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Id</span> <span class="p">=</span> <span class="n">timeoutId1</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">saga</span><span class="p">.</span><span class="n">Handle</span><span class="p">(</span><span class="k">new</span> <span class="n">OrderSubmitted</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">UserName</span> <span class="p">=</span> <span class="n">userName</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>        <span class="p">})</span>
</span><span class='line'>        <span class="p">.</span><span class="n">AssertSagaCompletionIs</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now we have the &ldquo;less happy&rdquo; path where the followup email needs to be sent:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="na">[Test]</span>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">OrderNotSubmitted</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">userName</span> <span class="p">=</span> <span class="s">&quot;sales@joshkodroff.com&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">timeoutId1</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">timeoutId2</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Test</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Saga</span><span class="p">&lt;</span><span class="n">AbandonedCartSaga</span><span class="p">&gt;()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">ExpectTimeoutToBeSetIn</span><span class="p">&lt;</span><span class="n">AbandonedCartTimeout</span><span class="p">&gt;((</span><span class="n">msg</span><span class="p">,</span> <span class="n">span</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">timeoutId1</span> <span class="p">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">Id</span><span class="p">;</span>
</span><span class='line'>            <span class="n">span</span><span class="p">.</span><span class="n">Should</span><span class="p">().</span><span class="n">Be</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="m">5</span><span class="p">));</span>
</span><span class='line'>        <span class="p">})</span>
</span><span class='line'>        <span class="p">.</span><span class="n">When</span><span class="p">(</span><span class="n">saga</span> <span class="p">=&gt;</span> <span class="n">saga</span><span class="p">.</span><span class="n">Handle</span><span class="p">(</span><span class="k">new</span> <span class="n">ItemAddedToCart</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">UserName</span> <span class="p">=</span> <span class="n">userName</span>
</span><span class='line'>        <span class="p">}))</span>
</span><span class='line'>        <span class="p">.</span><span class="n">ExpectTimeoutToBeSetIn</span><span class="p">&lt;</span><span class="n">AbandonedCartTimeout</span><span class="p">&gt;((</span><span class="n">msg</span><span class="p">,</span> <span class="n">span</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">timeoutId2</span> <span class="p">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">Id</span><span class="p">;</span>
</span><span class='line'>            <span class="n">span</span><span class="p">.</span><span class="n">Should</span><span class="p">().</span><span class="n">Be</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="m">5</span><span class="p">));</span>
</span><span class='line'>        <span class="p">})</span>
</span><span class='line'>        <span class="p">.</span><span class="n">When</span><span class="p">(</span><span class="n">saga</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">saga</span><span class="p">.</span><span class="n">Handle</span><span class="p">(</span><span class="k">new</span> <span class="n">ItemAddedToCart</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">UserName</span> <span class="p">=</span> <span class="n">userName</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// the first timeout comes back (which should be ignored):</span>
</span><span class='line'>            <span class="n">saga</span><span class="p">.</span><span class="n">Timeout</span><span class="p">(</span><span class="k">new</span> <span class="n">AbandonedCartTimeout</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Id</span> <span class="p">=</span> <span class="n">timeoutId1</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>        <span class="p">})</span>
</span><span class='line'>        <span class="p">.</span><span class="n">ExpectSendLocal</span><span class="p">&lt;</span><span class="n">SendAbandonedCartEmail</span><span class="p">&gt;(</span><span class="n">msg</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">msg</span><span class="p">.</span><span class="n">UserName</span><span class="p">.</span><span class="n">Should</span><span class="p">().</span><span class="n">Be</span><span class="p">(</span><span class="n">userName</span><span class="p">);</span>
</span><span class='line'>        <span class="p">})</span>
</span><span class='line'>        <span class="p">.</span><span class="n">When</span><span class="p">(</span><span class="n">saga</span> <span class="p">=&gt;</span> <span class="n">saga</span><span class="p">.</span><span class="n">Timeout</span><span class="p">(</span><span class="k">new</span> <span class="n">AbandonedCartTimeout</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Id</span> <span class="p">=</span> <span class="n">timeoutId2</span>
</span><span class='line'>        <span class="p">}))</span>
</span><span class='line'>        <span class="p">.</span><span class="n">AssertSagaCompletionIs</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Possible Future Enhancements and Conclusion</h2>

<p>What if we need to account for a new <code>ItemRemovedFromCart</code> message?  We&rsquo;d need to include the total number of items in the cart with the <code>ItemRemovedFromCart</code> message, and after that it&rsquo;s pretty simple: If <code>ItemRemovedFromCart.NumberOfCartItems</code> is zero, complete the saga because there&rsquo;s no items left in the cart.  If it&rsquo;s non-zero, then the handler has the same logic as <code>ItemAddedToCart</code>.  For testing, we&rsquo;ll need to add in a few of these messages to our happy path, then add in an additional test fixture or two that aseserts that the saga completes when there&rsquo;s no items left in the cart.)</p>

<p>What if we want to send additional follow-up emails after 7 and 30 days?  Well that would be pretty simple to add:  Just add timeouts for 7 and 30 days and change when the saga completes (after the 3rd email is sent instead of a single email).  It should also be pretty easy to test: extend our happy path test with a couple more assertions for the additional emails, and add 2 more less-happy tests for the order being placed before those timeouts happen.</p>

<p>We can see from the above examples that the saga is very well-suited to adapt to future changes in requirements.  I&rsquo;ve found NServiceBus sagas to be a fantastically-designed tool to handle some of the most difficult requirements I&rsquo;ve come across.  They take a minute to grok beacause they&rsquo;re so powerful, but once you have a good handle on their capabilities and get comfortable with how to fit them into your projects you can really, really get things done.</p>

<p>Happy coding!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Making Entity Framework More Unit-Testable]]></title>
    <link href="http://joshkodroff.com/blog/2015/08/08/making-entity-framework-more-testable/"/>
    <updated>2015-08-08T09:56:22-04:00</updated>
    <id>http://joshkodroff.com/blog/2015/08/08/making-entity-framework-more-testable</id>
    <content type="html"><![CDATA[<h2>Abstract</h2>

<p>For developers using <a href="https://entityframework.codeplex.com/">Entity Framework</a>, unit testing code that depends on the <code>DbContext</code> class is not the easiest thing.  If we&rsquo;re interested in doing unit testing, we need to be able to use an in-memory (&ldquo;fake&rdquo; in <a href="http://martinfowler.com/articles/mocksArentStubs.html">Martin Fowler&rsquo;s terminology</a>) version of <code>DbContext</code> comprised of lists of objects so that our tests do not hit the database.  This series of posts takes you through my process in getting to a facade on top of Entity Framework that results in testable code and tests that are fast to write.</p>

<!-- more -->


<p><em>Note:</em> The issues described are only known to apply to Entity Framework &lt;= 6.x.  EF 7 is a complete rewrite, so it&rsquo;s possible that these issues have since been addressed.</p>

<h2>tl;dr</h2>

<p>You can jump directly to <a href="https://github.com/jkodroff/ef-testable">the code</a>, or you can reference <a href="https://www.nuget.org/packages/EntityFrameworkTestable/">the client code NuGet package</a> in your main assemblies and <a href="https://www.nuget.org/packages/EntityFrameworkTestable.Testing/">the testing code NuGet package</a> in your testing assemblies.</p>

<h2>Part 1 - Getting to a Reusable Abstraction</h2>

<p>We want to depend on interfaces instead of concrete implementations, per the &ldquo;D&rdquo; (<a href="https://en.wikipedia.org/wiki/Dependency_inversion_principle">Dependency Inversion</a>) in <a href="https://en.wikipedia.org/wiki/SOLID_(object-oriented_design">SOLID</a>).  So how can we do this with Entity Framework?</p>

<p>Let&rsquo;s suppose we have the following <code>DbContext</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">MyDbContext</span> <span class="p">:</span> <span class="n">DbContext</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;</span> <span class="n">Orders</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="c1">// a bunch of other tables...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&hellip; we might be consuming it like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="kt">var</span> <span class="n">db</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MyDbContext</span><span class="p">();</span>
</span><span class='line'><span class="kt">var</span> <span class="n">order</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Orders</span><span class="p">.</span><span class="n">Single</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">id</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>&hellip; so if we naively extract an interface, then it will lead to something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IMyDbContext</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;</span> <span class="n">Orders</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="c1">// a bunch of other tables</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And that&rsquo;s not so good.</p>

<p>We have to change <code>IMyDbContext</code> along with <code>MyDbContext</code> every time we add a table to the database: We would have to add <code>DbSet&lt;T&gt;</code> properties to both the interface and the implementation.  We also cannot reuse this code across projects because our interface is tightly coupled to the particular database schema we&rsquo;re using.</p>

<p>Fortunately, <code>DbContext</code> exposes a <code>Set&lt;T&gt;()</code> method (<a href="https://msdn.microsoft.com/en-us/library/Gg696521%28v=VS.113%29.aspx">MSDN Docs</a>) which can help us solve this problem.  So, if we change how we consume our <code>DbContext</code> from <code>db.Orders</code> to <code>db.Set&lt;Order&gt;()</code>, we can now define our interface like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IDataSession</span> <span class="p">:</span> <span class="n">IDisposable</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">IDbSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Set</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">class</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// We also obviously need to persist our changes, so:</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">SaveChanges</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// I also have use cases where I need to drop down to raw SQL, so:</span>
</span><span class='line'>  <span class="kt">int</span> <span class="nf">SqlCommand</span><span class="p">(</span><span class="kt">string</span> <span class="n">sql</span><span class="p">,</span> <span class="k">params</span> <span class="kt">object</span><span class="p">[]</span> <span class="n">parameters</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The name change on the interface from <code>IMyDbContext</code> to <code>IDataSession</code> is intentional: it reflects that this interface is no longer a representation of a <em>particular</em> database context (i.e. <code>MyDbContext</code>), but <em>any</em> database context.  And we can create an implementation for it like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">EntityDataSession</span> <span class="p">:</span> <span class="n">IDataSession</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// This is the EF class, not ours:</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">DbContext</span> <span class="n">_dbContext</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">EntityDataSession</span><span class="p">(</span><span class="n">DbContext</span> <span class="n">dbContext</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">_dbContext</span> <span class="p">=</span> <span class="n">dbContext</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">_dbContext</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">IDbSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Set</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span>
</span><span class='line'>    <span class="err">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">_dbContext</span><span class="p">.</span><span class="n">Set</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">SaveChanges</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">_dbContext</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="nf">SqlCommand</span><span class="p">(</span><span class="kt">string</span> <span class="n">sql</span><span class="p">,</span> <span class="k">params</span> <span class="kt">object</span><span class="p">[]</span> <span class="n">parameters</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">_dbContext</span><span class="p">.</span><span class="n">Database</span><span class="p">.</span><span class="n">ExecuteSqlCommand</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">parameters</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can use our DI container to give us an <code>EntityDataSession</code> with whatever <code>DbContext</code> we want, and we can reuse this code across projects.  The code below is for <a href="http://docs.structuremap.net/">StructureMap</a>) but your DI container should have similar constructs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="c1">// Somewhere in your application&#39;s startup code:</span>
</span><span class='line'><span class="n">For</span><span class="p">&lt;</span><span class="n">IDataSession</span><span class="p">&gt;().</span><span class="n">Use</span><span class="p">&lt;</span><span class="n">EntityDataSession</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Because EntityDataSession takes a DbContext as a constructor param:</span>
</span><span class='line'><span class="n">For</span><span class="p">&lt;</span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">Entity</span><span class="p">.</span><span class="n">DbContext</span><span class="p">&gt;().</span><span class="n">Use</span><span class="p">&lt;</span><span class="n">MyDbContext</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>And we might consume our code like this.  (Sending your data model directly to a view is not advisable for production-quality code, but this is just an example):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SomeController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">IDataSession</span> <span class="n">_dataSession</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">SomeController</span><span class="p">(</span><span class="n">IDataSession</span> <span class="n">dataSession</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">_dataSession</span> <span class="p">=</span> <span class="n">dataSession</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Index</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">_dataSession</span><span class="p">.</span><span class="n">Set</span><span class="p">&lt;</span><span class="n">Orders</span><span class="p">&gt;())</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Part 2 - Testing</h2>

<p>We want to be able to write our tests with a minimum of incidental complexity.  In other words, we want to be able to create an in-memory implementation of <code>IDataSession</code>, specifying the tables and entities we need for the test - no more, and no less.  In order to provide a super-simple interface for our tests, we need to hide some complexity within our <code>IDataSession</code> wrapper.</p>

<p>Unfortunately, I was not able to accomplish this succintly without including a mocking library, albeit <a href="http://www.moqthis.com/">a very nicely written one</a>).  Any suggestions for improvement here would be greatly appreciated.  The implementation follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="c1">// Only to be included in test assemblies:</span>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">DataHelper</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="n">IDataSession</span> <span class="nf">Session</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">MockDataSession</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="n">IDataSession</span> <span class="n">Session</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">params</span> <span class="n">T</span><span class="p">[]</span> <span class="k">set</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span>
</span><span class='line'>    <span class="err">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nf">Session</span><span class="p">().</span><span class="n">AddSet</span><span class="p">(</span><span class="k">set</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="n">IDataSession</span> <span class="n">AddSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IDataSession</span> <span class="n">session</span><span class="p">,</span> <span class="k">params</span> <span class="n">T</span><span class="p">[]</span> <span class="k">set</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span>
</span><span class='line'>    <span class="err">{</span>
</span><span class='line'>        <span class="p">(</span><span class="n">session</span> <span class="k">as</span> <span class="n">MockDataSession</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Mock</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Set</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;())</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Returns</span><span class="p">(</span><span class="k">set</span> <span class="p">==</span> <span class="k">null</span> <span class="p">?</span> <span class="k">new</span> <span class="n">FakeDbSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span> <span class="p">:</span> <span class="k">new</span> <span class="n">FakeDbSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">set</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">mockSession</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">class</span> <span class="nc">MockDataSession</span> <span class="p">:</span> <span class="n">IDataSession</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">private</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IDataSession</span><span class="p">&gt;</span> <span class="n">_mock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IDataSession</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">internal</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IDataSession</span><span class="p">&gt;</span> <span class="n">Mock</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_mock</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">IDbSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">IDataSession</span><span class="p">.</span><span class="n">Set</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">_mock</span><span class="p">.</span><span class="n">Object</span><span class="p">.</span><span class="n">Set</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// This doesn&#39;t seem to be something that&#39;s really testable,</span>
</span><span class='line'>        <span class="c1">// so we&#39;ll concede this and throw an exception:</span>
</span><span class='line'>        <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">SqlQuery</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="kt">string</span> <span class="n">sql</span><span class="p">,</span> <span class="k">params</span> <span class="kt">object</span><span class="p">[]</span> <span class="n">parameters</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NotImplementedException</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// There&#39;s nothing to &quot;save&quot;, per se so it&#39;s just a NOOP</span>
</span><span class='line'>        <span class="k">public</span> <span class="k">void</span> <span class="nf">SaveChanges</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Part 3 - Putting it All Together</h2>

<p>Now that we have structured our client code so that it depends on interfaces instead of implementations, and we have an in-memory version of <code>IDataStore</code>, we can create tests that are fast to write, fast to execute, and test the necessary behavior of our program.  Here&rsquo;s an example of how we can do this:</p>

<p>Let&rsquo;s suppose we have a business rule that states &ldquo;customers on credit hold cannot place new orders&rdquo; (because they haven&rsquo;t paid their bills).  That rule might give us a controller that looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">OrdersController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// In a real application, we probably would not have IDataSession </span>
</span><span class='line'>    <span class="c1">// as a direct dependency in a controller, but for our purposes </span>
</span><span class='line'>    <span class="c1">// this is fine.</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">IDataSession</span> <span class="n">_dataSession</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">OrdersController</span><span class="p">(</span><span class="n">IDataSession</span> <span class="n">dataSession</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">_dataSession</span> <span class="p">=</span> <span class="n">dataSession</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">New</span><span class="p">(</span><span class="n">Guid</span> <span class="n">customerId</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">_dataSession</span><span class="p">.</span><span class="n">Set</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">&gt;().</span><span class="n">Single</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">customerId</span><span class="p">).</span><span class="n">OnCreditHold</span><span class="p">)</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">&quot;Customer is on credit hold and cannot place new orders.&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="k">new</span> <span class="n">NewOrderViewModel</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">CustomerId</span> <span class="p">=</span> <span class="n">customerId</span><span class="p">;</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can now write a test for this controller like this (the assertion syntax comes from <a href="http://www.fluentassertions.com/">FluentAssertions</a>):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="na">[TestFixture]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">OrdersControllerTests</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="na">    [Test]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">New_CustomerOnCreditHold</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">customerId</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">DataHelper</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Session</span><span class="p">(</span><span class="k">new</span> <span class="n">Customer</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Id</span> <span class="p">=</span> <span class="n">customerId</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">new</span> <span class="nf">OrdersController</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Invoking</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">New</span><span class="p">(</span><span class="n">customerId</span><span class="p">))</span>
</span><span class='line'>            <span class="p">.</span><span class="n">ShouldThrow</span><span class="p">&lt;</span><span class="n">Exception</span><span class="p">&gt;(</span><span class="s">&quot;*on credit hold*&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="c1">//                      ^^^^^^^^^^^^^^^^^^</span>
</span><span class='line'>            <span class="c1">// FluentAssertions will accept wildcard characters for</span>
</span><span class='line'>            <span class="c1">// matching exception text.</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And that&rsquo;s it!</p>

<h2>Conclusion</h2>

<p>Entity Framework can be a useful tool in the toolbelt, but it requires a little bit of work on top to keep your code testable.  Doing that work is well worth the gains in the ability to write tests that are fast to write, fast to execute, and let you focus on the business logic of your application.</p>

<p>Happy coding!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Getting More Inolved With OSS via Up for Grabs]]></title>
    <link href="http://joshkodroff.com/2015/06/11/getting-more-inolved-with-oss-via-up-for-grabs/"/>
    <updated>2015-06-11T00:00:00-04:00</updated>
    <id>http://joshkodroff.com/2015/06/11/getting-more-inolved-with-oss-via-up-for-grabs</id>
    <content type="html"><![CDATA[<p>I attended the <a href="http://dotnetfringe.org/">DotNetFringe</a> conference in Portland in April, and I met some some fantastic people, learned a ton, and had an overall great time. The conference was focused on open source in the .NET ecosystem, and I&#8217;m definitely a fan of both of those things.</p>

<!-- more -->


<p>While I&#8217;ve been a consumer of much open source software for a long time, <a href="https://github.com/jkodroff">I&#8217;m not where I&#8217;d like to be in terms of giving back to the community</a> (i.e. there ain&#8217;t a lot of green on my contrib chart at the time of writing this post). I want that to change, so I&#8217;m committing (pun sorta-intentional) to doing 1 pull request per month for projects on <a href="http://up-for-grabs.net/#/">Up For Grabs</a> projects.</p>

<p>And what is Up for Grabs? Up For Grabs is a project created by <a href="https://lostechies.com/keithdahlby/">Keith Dahlby</a> of <a href="http://dahlbyk.github.io/posh-git/">posh-git</a> fame. Basically, you add your project to a manifest of open source projects and associate a GitHub issue tag with what I like to call &#8220;shovel-ready&#8221; issues: issues which the maintainers have oked so you know that the PR is likely to be approved. I think this is a fantastic idea and really helps lower the barrier to entry for becoming an OSS contributor.</p>

<p>If you&#8217;re a project maintainer, you should list your project with Up For Grabs. If you want to get more involved as a contributor, you should gind some issues on Up For Grabs. Big thanks to Keith for making this happen.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[The Josh Test &#8211; a Sorta-Objective Way to Analyze New Opportunities]]></title>
    <link href="http://joshkodroff.com/2014/02/08/the-josh-test-a-sorta-objective-way-to-analyze-new-opportunities/"/>
    <updated>2014-02-08T00:00:00-05:00</updated>
    <id>http://joshkodroff.com/2014/02/08/the-josh-test-a-sorta-objective-way-to-analyze-new-opportunities</id>
    <content type="html"><![CDATA[<p>I find myself in the incredibly fortunate position of having a skill set that is greatly in demand. I get calls and emails on a near-daily basis from recruiters for all types of jobs. (If you don&#8217;t think that having recruiters contact you on a daily basis is a good problem to have, I would advise you to consider the employment circumstances of anyone else who is not a medical or IT professional, i.e. the other 99.999% of the world.) While there&#8217;s a lot to like about my current position, it would be foolish to be closed to new opportunities if the right one comes up. But how do I now what &#8220;the right opportunity&#8221; looks like? My answer: The Josh Test.</p>

<!-- more -->


<p>In August of 2000, software blogging Godfather <a href="http://www.joelonsoftware.com/">Joel Spolsky</a> posted <a href="http://www.joelonsoftware.com/articles/fog0000000043.html">a simple and quick 12-point checklist</a> to see if an organization is doing good development work. The points have become a little outdated with time, but it still remains a good yardstick to measure a software organization. I wanted to iterate on this concept so that I could devise a test for potential opportunities that I might come across.</p>

<p>What I came up with was a list of what I consider the key dimensions software job. Each dimension can be scored on a scale of 1 to X. X is higher for more important things, lower for less important things. Figuring out whether a position you&#8217;re considering is a significant upgrade is simple: run the test for your current position, run the test for the potential position and compare the totals.</p>

<p>Side note: unless there’s a big positive difference, I might advise staying put. &#8220;Grass is greener&#8221; and whatnot.</p>

<p>In addition, I&#8217;ve compiled a list of deal-breakers so that I know what positions are automatically out of consideration. It&#8217;s good to know what your personal boundaries are and to stick to them.</p>

<p>If you&#8217;re doing your own Josh Test (in which case it should be called the [Your name here] Test), adjust the point scales to your values: e.g. Maybe you don&#8217;t care about an office environment at all, but you need more money because you’ve got high-interest debt. In addition, it&#8217;s important that your renew your [Your name here] Test as your priorities change.</p>

<p>And without further ado, I present the Josh Test v1.0:</p>

<h2>Location: 7 point scale</h2>

<p>I live in Philadelphia and I really like this city. My family and friends live here, I&#8217;m in a band, and so moving to another town (especially one where I don&#8217;t know anyone) would involve restarting my whole social life. That said, I&#8217;m open to positions in other locations that have the things that I value in my life outside of work: a vibrant arts and music scene, public parks, good public transit and bikeability, existing friends in town, and affordable living.</p>

<p>What would my commute to work be like? My current commute is perfect &#8211; a mile away, easily reached by bike, or on foot. If the weather is crappy, I can work from home or drive in and park for $7. On the other hand, I&#8217;ve worked a position where my commute was over an hour each way in traffic to a town I wanted nothing to do with once the workday was done and it was a miserable experience. Being easily reachable by public transit is another plus.</p>

<h2>Compensation: 7 point scale</h2>

<p>Is your pay comparable with the market rates? How about vacation? How about other perks?</p>

<p>Side note: I highly recommend the <a href="http://www.kalzumeus.com/2012/01/23/salary-negotiation/">Kalzumeus Blog’s entry on Salary Negotiation.</a></p>

<h2>Office Environment: 5 point scale</h2>

<p>My ideal office environment is clean, beautiful, has quiet places, and is conducive to collaboration and productivity. I find myself inspired to come to work and do my best when it&#8217;s obvious that the folks in charge have put effort into making a place that&#8217;s pleasant to spend a lot of time in.</p>

<p>I want to work on equipment (monitors, machines, software, etc) that are top notch because they are enjoyable to use and keep me productive. Considering the cost of developers vs. the cost of equipment, it&#8217;s always been a no-brainer to me that if you value your people you should get them whatever equipment they want within reason.</p>

<p>I want office furniture that&#8217;s sturdy and reasonably ergonomic. Forcing your employees to work with crappy desks or buying the cheapest possible chair at Ikea shows a disregard for your employees&#8217; health and happiness.</p>

<p>I find collaboration makes for more productivity and happiness. Is it easy to collaborate with my coworkers? Do you have the software (e.g. HipChat, Confluence, BaseCamp, etc.) and physical tools (shared spaces, whiteboards) that facilitate collaboration and openness?</p>

<p>If I need to concentrate because I need to think over some complicated technical task, is there a place for that? If I need to take a personal call during work hours (hey, it happens to us all sometimes) is there a place for that?</p>

<h2>Confidence in the product/company: 8 point scale</h2>

<p>If you make a product, is it one that I would choose, compared to the competition? Is its quality something I would be proud to show my friends? Does it deliver good value to the users?</p>

<p>As stated below, any product or client that does societal harm is out of the running, but do you do work for the common good? Do you serve public education? Non-profits committed to social good? Are you a university? A public institution? Knowing the work I do makes a key difference in someone&#8217;s well-being (and not just their bottom line) makes coming to work feel more meaningful.</p>

<p>The company matters too. Do I feel confident that the company will remain or become profitable? Do I feel that management knows what they’re doing in terms of the direction of the company? Is there a low attrition rate? You probably don’t want to be on a sinking ship, much less get on one voluntarily.</p>

<h2>My team/immediate coworkers: 10 point scale</h2>

<p>I’ve worked on teams where I could not trust my team members to do their work correctly and it sucked. I’ve also worked on teams where my trust was well-placed and it was great. If you’re up for positions of leadership, do your best to ensure that it’s the latter, but if it’s the former get an assurance from management that you can make the necessary personnel changes in due time, or get the expectations sufficiently lowered.</p>

<p>Are there people who are willing and able to mentor me in the technical and interpersonal skills I want to develop? Are there people who are willing and able to be mentored by me? I’ve learned as much from teaching as being taught and enjoy both.</p>

<h2>The work: 10 point scale</h2>

<p>Are you using technologies that I&#8217;m interested in? What are my prospects to improve and expand my skill set? In this business, if you&#8217;re not learning for an extended period of time you&#8217;re probably doing your career harm. Not irreparable harm, but you definitely don&#8217;t want to get too far behind.</p>

<p>Do you have career mentoring? Whatever your craft is, it&#8217;s a lot easier to master it with an experienced and trustworthy teacher. The same goes for developing interpersonal skills, which are at least as important. Likewise, I want to be supported by the organization in teaching my less experienced coworkers what I know and help them achieve their own career goals.</p>

<p>If my capabilities outgrow my responsibilities, are you going to be able to let me do for the organization what I&#8217;m most qualified to do? If my interests were to change, are you going to be able to give me work that is in line with those interests and the needs of the company?</p>

<p>Is the current quality of your code good (in the sense that it works well and has a low bug count)?</p>

<h2>My Automatic Deal Breakers (YMMV)</h2>

<p>These things make it easy to rule out potential positions:</p>

<ul>
<li>Products or clients that cause serious environmental or societal harm. For example, I have a personal precept that I will not do business with weapons manufacturers or major polluters. If you have similar rules (whatever they may be), make sure you stick by them. No job is worth violating a value you hold dearly.</li>
<li>Any indication of unscrupulous behavior. I can&#8217;t work with you if I can&#8217;t trust you to deal with me (or your clients) in good faith.</li>
<li>Positions in areas in which I don&#8217;t want to live. There&#8217;s no amount of money that&#8217;s worth it to move to an area where I won&#8217;t have the life I want outside of work.</li>
<li>Extensive use of technologies I intensely dislike working with with no mandate to change them soon. For example, I’m not willing to go back to editing stored procedures or dealing with WebForms markup all day if I’ve got better options. It also makes it hard to recruit good developers to be on your team.</li>
<li>Commute time longer than 45 minutes from someplace I would like to live. I&#8217;ve done it before and it wasn’t fun.</li>
</ul>


<h2>Conclusion</h2>

<p>The point values may change every few months. Maybe I visited Topeka, Kansas on vacation and I’m not so attached to the The City of Brotherly Love, so location doesn’t matter so much. (Hey, it could happen…) The Josh Test is just a rule of thumb (never let it overrule your intuition), but hopefully you can adapt it to your own situation and just maybe it’ll help you discover a great opportunity!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[It&#8217;s High Time to Make Windows Development Cheaper]]></title>
    <link href="http://joshkodroff.com/2013/05/14/its-high-time-to-make-windows-development-cheaper/"/>
    <updated>2013-05-14T00:00:00-04:00</updated>
    <id>http://joshkodroff.com/2013/05/14/its-high-time-to-make-windows-development-cheaper</id>
    <content type="html"><![CDATA[<p>At work, I use a MacBook Pro and boot into Windows directly using BootCamp. I tried using <a href="https://www.virtualbox.org/">VirtualBox</a> but key bindings not matching up drove me nuts and I was trying to get a project launched on a tight deadline, so I went with what I knew.</p>

<p>As a reward for launching said project, I got myself a nice new MacBook Pro for home use with a Retina screen, and 16 GB RAM. Professional tools for a professional developer and whatnot.</p>

<!-- more -->


<p>So I&#8217;m doing a little extra studying on <a href="http://tekpub.com/">TekPub</a> in my off-hours, watching <a href="http://tekpub.com/productions/nsb/1">Udi Dahan&#8217;s intro to NServiceBus</a>. I&#8217;ve never taken Udi&#8217;s course so I wanted to make sure I hadn&#8217;t missed anything that could make my work significantly easier.</p>

<p>Long story short, I found some code that I wanted to try out here at home so I start looking into what it would take for me to have my own legal copies of my work development environment. What I found did not make me very happy:</p>

<ol>
<li><a href="https://buy.parallels.com/329/purl-us-pd8f">Parallels Desktop for Mac 8: $79.99</a></li>
<li><a href="http://www.microsoftstore.com/store/msusa/en_US/pdp/productID.278119500?mr:referralID=a9233989-bd09-11e2-9dea-001b2166becc">Windows 8 Professional: $199.99</a></li>
<li><a href="http://www.microsoftstore.com/store/msusa/en_US/pdp/productID.254640600?mr:referralID=c120e554-bd09-11e2-9dea-001b2166becc">Visual Studio 2012 Professional: $499.99</a></li>
<li><a href="http://www.jetbrains.com/resharper/buy/index.jsp">ReSharper 7 Personal License: $199.99</a></li>
</ol>


<p>Total: <strong>$979.96</strong></p>

<p>So I&#8217;ll be out about a grand before I can set up a machine to do a little extra .NET learning at home? Ouch. Each of these by themselves isn&#8217;t terribly unreasonable (with the possible exception of Visual Studio) however, the problem is that in total it&#8217;s making it damn near impossible to continue to work with .NET (while obeying the license terms) in my spare time. If Microsoft wants to keep up with their open source competition for my development talent (for whatever that&#8217;s worth), then they need to get the cost down. <em>A lot.</em></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[DDD Lesson &#8211; Break Out Your CRUD]]></title>
    <link href="http://joshkodroff.com/2013/04/21/ddd-lesson-break-out-your-crud/"/>
    <updated>2013-04-21T00:00:00-04:00</updated>
    <id>http://joshkodroff.com/2013/04/21/ddd-lesson-break-out-your-crud</id>
    <content type="html"><![CDATA[<p>In my view, there&#8217;s 2 main principles that distinguish Domain-driven design as an approach to solving problems:</p>

<ol>
<li>All solutions to problems are framed in terms of the value delivered to the stakeholders for the effort required.</p></li>
<li>The core of the code is a model of the business process, and it <a href="https://en.wikipedia.org/wiki/Code_refactoring">evolves with time</a> as the  developers&#8217; understanding of the business with time.</li>
</ol>


<!-- more -->


<p>There&#8217;s other principles involved, but these two are the most relevant fo this particular post.</p>

<p>Sounds pretty generic, right?  So how do we implement this?  You may find, as I did, that direct advice (i.e. rules of thumb) on how to write domain-driven code is tough to find.  DDD is a very powerful technique for software development, but even though it&#8217;s has been popular for about 10 years now best practices are not yet widely understood.  There&#8217;s a long line of developers burned by DDD because they didn&#8217;t have a proper understanding of where domain models are appropriate.  They end up writing more code than they need to, and DDD gets a bad rap.  That&#8217;s a bummer because when it&#8217;s applied with wisdom, DDD really can make one&#8217;s life as a coder easier.</p>

<p>Let&#8217;s say we have the concept of an order in our domain. For simplicity&#8217;s sake, it takes 1 address for both billing and shipping.  All fields are required for the address.  It also has a status (InProgress, Placed, Shipped, or Cancelled) and we have some fairly intuitive rules about which status changes are valid (e.g. an order cannot be cancelled after it&#8217;s shipped).</p>

<p>Given the rules above, we start coding and come up with an interface like this. We&#8217;re showing the interface here for brevity &#8211; the implementation should be fairly obvious:</p>

<pre><code>public interface IOrder {

    void SetAddress(string streetNumber, string city, string state, string zip);

    // throw an exception if status == Shipped or Cancelled
    void Place();

    // throw an exception if status == In Progress or Cancelled
    void MarkShipped();

    // throw an exception if status == Shipped
    void Cancel();
}
</code></pre>

<p>Stop. Do you see the problem here?</p>

<p>Think ahead a little bit. We need to both persist and edit this thing in the UI. We want to obey the <a href="http://en.wikipedia.org/wiki/Single_responsibility_principle">Single Responsibility Principle</a> so we don&#8217;t want to re-use our domain class for editing or persistence since those are different responsibilities. Thus, we end up with some additional classes: maybe <code>OrderRepository</code> for persisting, which has to map the attribs to a class like <code>OrderData</code> which is compatible with our ORM, and then we need to edit the thing in the UI so we make an <code>OrderViewModel</code> where we declare which fields are required in the UI. And now, we&#8217;ve got a LOT of code on our hands which in turn becomes a PITA to maintain. This is not what we hoped for when we ventured down the path of DDD. It was supposed to make our lives easier and now we have tons of code and a headache. (And possibly a heartarche depending on how passionate we are about our craft&#8230;)</p>

<p>So what did we do wrong? <em>We made the assumption that Order has to be one object.</em> It&#8217;s totally understandable &#8211; we&#8217;re making a model of an order, and in the paper world an order is one sheet of paper. However, if we naively carry the assumption that concepts map 1:1 to classes in our domain model we may well be making things worse. Here&#8217;s what we do instead:</p>

<p>The address on the order is just straight CRUD. There&#8217;s no behavior here other than validating that the required fields are there and we&#8217;ve got plenty of tools that will do this for us (e.g. DataAnnotations in the .NET world). Thus, we can use a single class to represent our persistence model all the way up to the UI. One class fills all of our needs as far as the address goes:</p>

<pre><code>public class OrderAddress {
    public Guid Id { get; set; }

    [Required]
    public string StreetNumber { get; set; }

    [Required]
    public string City { get; set; }

    [Required]
    public string State { get; set; }

    [Required]
    public string Zip { get; set; }
}
</code></pre>

<p>No need for unit tests on this class since there&#8217;s no behavior to test. We can safely assume that validation is handled correctly by our client framework (e.g. jQuery validation in ASP.NET MVC) or at worst our database. (If we can&#8217;t safely assume this we may need to consider some new tools&#8230;)</p>

<p>As for the status changes, now we end up with this (same as before, but no <code>SetAddress()</code>):</p>

<pre><code>public interface IOrderStatus {

    // throw an exception if status == Shipped or Cancelled
    void Place();

    // throw an exception if status == In Progress or Cancelled
    void MarkShipped();

    // throw an exception if status == Shipped
    void Cancel();
}
</code></pre>

<p>This also means we persist OrderAddress and OrderStatus as separate tables (or collections if you&#8217;re using a document database). Because they&#8217;re separate tables, we&#8217;ve also decreased our risk of concurrency issues in addition to making maintenance easier by decoupling. Now the code benefits from a true domain model where it&#8217;s actually helpful: where there&#8217;s behavior. And we can use plain old CRUD like we did before when there&#8217;s no behavior, just data.</p>

<p>So, we can summarize the lessons in this post in the following rules of thumb:</p>

<ol>
<li>If the current state of the data is not dependent upon the previous state of the data, then it&#8217;s simple CRUD and we do not need a domain model. We should use the same class from the DB all the way through the UI.</li>
<li>If the current state of the data is dependent upon the previous state of the data, then it&#8217;s a state machine, has behavior, and we probably will benefit from a domain model.  Our behavior should be encapsulated in a class which has all methods and no mutators (setters).</li>
<li>Break apart classes (and tables/document collections) accordingly in order to separate the state and behavior so we don&#8217;t write unnecessary code and create unnecessary coupling.</li>
</ol>


<p>This is something I wish I had understood when I started doing DDD.  I hope this post clarifies things for you and saves you some trouble.</p>
]]></content>
  </entry>
  
</feed>
